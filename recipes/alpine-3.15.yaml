memory: 512
disk: 10G
iso: https://dl-cdn.alpinelinux.org/alpine/v3.15/releases/{arch}/alpine-virt-3.15.4-{arch}.iso

steps:
  - name: boot
    wait: "\n\rlocalhost login: $"

  - name: login
    send: "root\n"
    wait: "\r\n(localhost|alpine):~# (\x1b\\[6n)?$"

  - name: hwclock
    send: "hwclock --hctosys\n"
    wait: "\r\n(localhost|alpine):~# (\x1b\\[6n)?$"

  - name: setup-alpine
    send: "setup-alpine -q\n"
    wait: "\r\nSelect keyboard layout: \\[none\\] $"

  - name: keyboard layout
    send: "\n"
    wait: "\r\n(localhost|alpine):~# (\x1b\\[6n)?$"

  - name: setup-disk
    send: "setup-disk -m sys -s 0 /dev/vda\n"
    wait: "\r\nWARNING: Erase the above disk\\(s\\) and continue\\? \\(y/n\\) \\[n\\] $"

  - name: setup-disk yes please
    send: "y\n"
    wait: "\r\n(localhost|alpine):~# (\x1b\\[6n)?$"
    timeout: 60

  - name: reboot
    send: "reboot\n"
    wait: "\n\ralpine login: $"

  - name: log in again
    send: "root\n"
    wait: "\r\n(localhost|alpine):~# (\x1b\\[6n)?$"

  - name: community repo
    send: "echo 'http://dl-cdn.alpinelinux.org/alpine/v3.15/community' >> /etc/apk/repositories\n"
    wait: "\r\n(localhost|alpine):~# (\x1b\\[6n)?$"

  - name: sshd
    send: "setup-sshd\n"
    wait: "\r\nWhich SSH server\\? \\('openssh', 'dropbear' or 'none'\\) \\[openssh\\] "

  - name: choose openssh
    send: "\n"
    wait: "\r\n(localhost|alpine):~# (\x1b\\[6n)?$"

  - name: vagrant ssh key
    send: "apk add curl && mkdir ~/.ssh && chmod 700 ~/.ssh && curl https://raw.githubusercontent.com/hashicorp/vagrant/master/keys/vagrant.pub > ~/.ssh/authorized_keys && chmod 600 ~/.ssh/authorized_keys\n"
    wait: "\r\n(localhost|alpine):~# (\x1b\\[6n)?$"

  - name: grub timeout
    if_arch: 'aarch64'
    send: "echo 'GRUB_TIMEOUT=0' >> /etc/default/grub && grub-mkconfig -o /boot/grub/grub.cfg\n"
    wait: "\r\n(localhost|alpine):~# (\x1b\\[6n)?$"

  - name: default grub target
    if_arch: 'x86_64'
    send: "echo 'DEFAULT virt' >> /boot/extlinux.conf\n"
    wait: "\r\n(localhost|alpine):~# (\x1b\\[6n)?$"

  - name: poweroff
    send: "poweroff\n"

tests:
  - name: Alpine release number
    run: cat /etc/alpine-release
    expect: '^3\.15'

  - name: Kernel version
    run: uname -a
    expect: '^Linux alpine 5.15'
